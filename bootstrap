#!/usr/bin/env zsh

# Bootstrap a new machine.
#
# Arguments passed in are directly passed to `ansible-playbook`

DEBUG=

function print_bootstrap() {
  cat << 'EOF'
 _                 _       _
| |__   ___   ___ | |_ ___| |_ _ __ __ _ _ __
| '_ \ / _ \ / _ \| __/ __| __| '__/ _` | '_ \
| |_) | (_) | (_) | |_\__ \ |_| | | (_| | |_) |
|_.__/ \___/ \___/ \__|___/\__|_|  \__,_| .__/
                                        |_|
EOF
}


function install_homebrew() {
  print "\nChecking for homebrew"
  [ -z "$(command -v brew)" ] || return 0
  /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
  (echo; echo 'eval "$(/opt/homebrew/bin/brew shellenv)"') >> "$HOME/.zprofile"
  eval "$(/opt/homebrew/bin/brew shellenv)"
}

function install_ansible() {
  print "\nChecking for ansible"
  [ -z "$(command -v ansible)" ] && brew install ansible
}

function install_nvim_plugins() {
  [ -f "$HOME/.config/m-housh/init.lua" ] && \
    print "\nInstalling neovim plugins, this may take a while" && \
    nvim --headless "+Lazy! sync" +qa
}

function main() {
  print_bootstrap
  install_homebrew
  install_ansible

  print "\nInstalling ansible-playbook requirements"
  ansible-galaxy install -r requirements.yml

  print "\nRunning ansible-playbook with args: $@"
  print "\nThis may ask for your password several times during it's run."
  [ -z "$DEBUG" ] && \
    ansible-playbook main.yml --ask-become-pass "$@" || \
    print "\nAborting because in debug mode"

  print "\nFixing permissions on homebrew share directory"
  chmod -R g-w "/opt/homebrew/share"

  install_nvim_plugins

  print "\nReloading shell."
  exec zsh -l


  print "Done. Note some changes require a reboot to take effect."
}

main "$@"

